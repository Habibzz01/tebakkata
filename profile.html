<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil - Game Tebak Kata</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="dbs.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <nav class="nav">
                <div class="logo">Game Tebak Kata</div>
                <div class="nav-links">
                    <a href="dashboard.html">Dashboard</a>
                    <a href="index.html">Beranda</a>
                    <button class="theme-toggle" onclick="toggleTheme()">🌙</button>
                    <button class="btn btn-error" onclick="logout()">Logout</button>
                </div>
            </nav>
        </div>

        <div class="profile-content">
            <div class="profile-header animate-fadeIn">
                <div class="profile-avatar" id="userAvatar">U</div>
                <h2 id="userName">Loading...</h2>
                <p id="userEmail">Loading...</p>
            </div>

            <div class="card animate-fadeIn" style="max-width: 600px; margin: 2rem auto;">
                <h3 style="margin-bottom: 2rem; color: var(--primary-color);">Edit Profil</h3>
                
                <form id="profileForm">
                    <div class="form-group">
                        <label class="form-label">Nama Lengkap</label>
                        <input type="text" class="form-input" id="fullName" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="email" readonly>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Update Profil</button>
                </form>
            </div>

            <div class="card animate-fadeIn" style="max-width: 600px; margin: 2rem auto;">
                <h3 style="margin-bottom: 2rem; color: var(--primary-color);">Ganti Password</h3>
                
                <form id="passwordForm">
                    <div class="form-group">
                        <label class="form-label">Password Baru</label>
                        <input type="password" class="form-input" id="newPassword" required minlength="6">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Konfirmasi Password Baru</label>
                        <input type="password" class="form-input" id="confirmNewPassword" required minlength="6">
                    </div>
                    
                    <button type="submit" class="btn btn-secondary" style="width: 100%;">Ganti Password</button>
                </form>
            </div>

            <div class="card animate-fadeIn" style="max-width: 600px; margin: 2rem auto;">
                <h3 style="margin-bottom: 2rem; color: var(--error-color);">Zone Berbahaya</h3>
                
                <div style="text-align: center;">
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                        Menghapus akun akan menghapus semua data Anda secara permanen dan tidak dapat dikembalikan.
                    </p>
                    <button class="btn btn-error" onclick="confirmDeleteAccount()">Hapus Akun Saya</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Theme Toggle
        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            const themeToggle = document.querySelector('.theme-toggle');
            themeToggle.textContent = newTheme === 'dark' ? '☀️' : '🌙';
        }

        // Load saved theme
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
            const themeToggle = document.querySelector('.theme-toggle');
            themeToggle.textContent = savedTheme === 'dark' ? '☀️' : '🌙';
            
            // Check authentication
            auth.onAuthStateChanged(function(user) {
                if (user) {
                    loadUserData(user);
                } else {
                    window.location.href = 'login.html';
                }
            });
        });

        // Load user data
        function loadUserData(user) {
            document.getElementById('userName').textContent = user.displayName || 'User';
            document.getElementById('userEmail').textContent = user.email;
            document.getElementById('userAvatar').textContent = (user.displayName || 'U').charAt(0).toUpperCase();
            document.getElementById('fullName').value = user.displayName || '';
            document.getElementById('email').value = user.email;
        }

        // Profile form submission
        document.getElementById('profileForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const fullName = document.getElementById('fullName').value;
            const user = auth.currentUser;
            
            user.updateProfile({
                displayName: fullName
            }).then(() => {
                // Update database
                database.ref('users/' + user.uid).update({
                    fullName: fullName
                });
                
                showToast('Profil berhasil diperbarui!', 'success');
                loadUserData(user);
            }).catch((error) => {
                showToast('Error: ' + error.message, 'error');
            });
        });

        // Password form submission
        document.getElementById('passwordForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmNewPassword').value;
            
            if (newPassword !== confirmPassword) {
                showToast('Password tidak cocok!', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                showToast('Password minimal 6 karakter!', 'error');
                return;
            }
            
            const user = auth.currentUser;
            user.updatePassword(newPassword)
                .then(() => {
                    showToast('Password berhasil diganti!', 'success');
                    document.getElementById('passwordForm').reset();
                })
                .catch((error) => {
                    showToast('Error: ' + error.message, 'error');
                });
        });

        // Confirm delete account
        function confirmDeleteAccount() {
            if (confirm('Apakah Anda yakin ingin menghapus akun Anda? Tindakan ini tidak dapat dibatalkan.')) {
                deleteAccount();
            }
        }

        // Delete account
        function deleteAccount() {
            const user = auth.currentUser;
            
            // Delete user data from database
            database.ref('users/' + user.uid).remove()
                .then(() => {
                    // Delete user from authentication
                    user.delete()
                        .then(() => {
                            showToast('Akun berhasil dihapus!', 'success');
                            setTimeout(() => {
                                window.location.href = 'index.html';
                            }, 1500);
                        })
                        .catch((error) => {
                            showToast('Error: ' + error.message, 'error');
                        });
                })
                .catch((error) => {
                    showToast('Error: ' + error.message, 'error');
                });
        }

        // Logout function
        function logout() {
            auth.signOut()
                .then(() => {
                    showToast('Logout berhasil!', 'success');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 1000);
                })
                .catch((error) => {
                    showToast('Error: ' + error.message, 'error');
                });
        }

        // Toast notification function
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }
    </script>
</body>
</html>