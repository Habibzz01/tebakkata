<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Game Tebak Kata</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="dbs.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <nav class="nav">
                <div class="logo">Game Tebak Kata</div>
                <div class="nav-links">
                    <a href="index.html">Beranda</a>
                    <a href="profile.html">Profil</a>
                    <a href="tambahsoal.html">Kelola Soal</a>
                    <button class="theme-toggle" onclick="toggleTheme()">üåô</button>
                    <button class="btn btn-error" onclick="logout()">Logout</button>
                </div>
            </nav>
        </div>

        <div class="dashboard-content">
            <div class="profile-header animate-fadeIn">
                <div class="profile-avatar" id="userAvatar">U</div>
                <h2 id="userName">Loading...</h2>
                <p id="userEmail">Loading...</p>
            </div>

            <div class="game-container">
                <div class="game-board animate-fadeIn">
                    <h3 style="text-align: center; margin-bottom: 1rem; color: var(--primary-color);">Statistik Anda</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                        <div class="card" style="text-align: center;">
                            <h4 style="color: var(--primary-color); font-size: 2rem;" id="totalScore">0</h4>
                            <p style="color: var(--text-secondary);">Total Skor</p>
                        </div>
                        <div class="card" style="text-align: center;">
                            <h4 style="color: var(--secondary-color); font-size: 2rem;" id="gamesPlayed">0</h4>
                            <p style="color: var(--text-secondary);">Game Dimainkan</p>
                        </div>
                        <div class="card" style="text-align: center;">
                            <h4 style="color: var(--accent-color); font-size: 2rem;" id="avgScore">0</h4>
                            <p style="color: var(--text-secondary);">Rata-rata Skor</p>
                        </div>
                    </div>
                </div>

                <div class="leaderboard animate-fadeIn">
                    <h3 style="margin-bottom: 1rem; color: var(--primary-color);">üèÜ Leaderboard</h3>
                    <div id="leaderboardList">
                        <div class="spinner" style="margin: 2rem auto;"></div>
                    </div>
                </div>
            </div>

            <div class="card animate-fadeIn" style="margin-top: 2rem;">
                <h3 style="margin-bottom: 1rem; color: var(--primary-color);">Pilihan Game</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <a href="index.html" class="btn btn-primary" style="text-align: center;">
                        üéÆ Main Game
                    </a>
                    <a href="tambahsoal.html" class="btn btn-secondary" style="text-align: center;">
                        üìù Kelola Soal
                    </a>
                    <a href="profile.html" class="btn btn-secondary" style="text-align: center;">
                        üë§ Edit Profil
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Theme Toggle
        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            const themeToggle = document.querySelector('.theme-toggle');
            themeToggle.textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }

        // Load saved theme
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
            const themeToggle = document.querySelector('.theme-toggle');
            themeToggle.textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            
            // Check authentication
            auth.onAuthStateChanged(function(user) {
                if (user) {
                    loadUserData(user);
                    loadLeaderboard();
                } else {
                    window.location.href = 'login.html';
                }
            });
        });

        // Load user data
        function loadUserData(user) {
            document.getElementById('userName').textContent = user.displayName || 'User';
            document.getElementById('userEmail').textContent = user.email;
            document.getElementById('userAvatar').textContent = (user.displayName || 'U').charAt(0).toUpperCase();
            
            // Load user statistics
            database.ref('users/' + user.uid).once('value')
                .then((snapshot) => {
                    const userData = snapshot.val();
                    if (userData) {
                        document.getElementById('totalScore').textContent = userData.totalScore || 0;
                        document.getElementById('gamesPlayed').textContent = userData.gamesPlayed || 0;
                        
                        const avgScore = userData.gamesPlayed > 0 ? Math.round(userData.totalScore / userData.gamesPlayed) : 0;
                        document.getElementById('avgScore').textContent = avgScore;
                    }
                });
        }

        // Load leaderboard
        function loadLeaderboard() {
            database.ref('leaderboard').orderByChild('score').limitToLast(10).once('value')
                .then((snapshot) => {
                    const leaderboardList = document.getElementById('leaderboardList');
                    leaderboardList.innerHTML = '';
                    
                    const leaderboardData = [];
                    snapshot.forEach((childSnapshot) => {
                        leaderboardData.push({
                            key: childSnapshot.key,
                            ...childSnapshot.val()
                        });
                    });
                    
                    // Sort by score descending
                    leaderboardData.sort((a, b) => b.score - a.score);
                    
                    if (leaderboardData.length === 0) {
                        leaderboardList.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Belum ada data</p>';
                        return;
                    }
                    
                    leaderboardData.forEach((entry, index) => {
                        const item = document.createElement('div');
                        item.className = 'leaderboard-item';
                        item.innerHTML = `
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <span class="rank">#${index + 1}</span>
                                <div>
                                    <div style="font-weight: 600;">${entry.name}</div>
                                    <div style="font-size: 0.8rem; color: var(--text-secondary);">${new Date(entry.timestamp).toLocaleDateString()}</div>
                                </div>
                            </div>
                            <div style="font-weight: 700; color: var(--primary-color);">${entry.score}</div>
                        `;
                        leaderboardList.appendChild(item);
                    });
                });
        }

        // Logout function
        function logout() {
            auth.signOut()
                .then(() => {
                    showToast('Logout berhasil!', 'success');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 1000);
                })
                .catch((error) => {
                    showToast('Error: ' + error.message, 'error');
                });
        }

        // Toast notification function
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }
    </script>
</body>
</html>